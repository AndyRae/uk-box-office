{% extends 'base.html' %}

{% block title %} {{ time }} {% endblock %}

{% block schema %}
	{
		"@context":"https://schema.org/",
		"@type":"Dataset",
		"name":"{{ time }} Box Office Data",
		"description":"Weekly UK Cinema Box Office data for {{ time }}.",
		"url":"/",
		"isBasedOn":"https://www.bfi.org.uk/industry-data-insights/weekend-box-office-figures",
		"keywords":[
		"BOX OFFICE DATA > CINEMA > {{ time }}",
		],
		"isAccessibleForFree" : true,
		"creator":{
		"@type":"Organization",
		"url": "https://boxofficedata.co.uk",
		"name":"Box Office Data UK",
		"contactPoint":{
			"@type":"ContactPoint",
			"contactType": "customer service",
			"email":"hello@boxofficedata.co.uk"
		}
		},
		"funder":{
		"@type": "Organization",
		"sameAs": "https://ror.org/04qg9vz18",
		"name": "British Film Institute"
		},
		"includedInDataCatalog":{
		"@type":"DataCatalog",
		"name":"Box Office Data UK"
		},
		"distribution":[
		{
			"@type":"DataDownload",
			"encodingFormat":"CSV",
			"contentUrl":"https://boxofficedata.co.uk"
		},
		],
		"temporalCoverage":"{{ time }}",
	}
{% endblock %}

{% block header %}
<div class="uk-container">
	<ul class="uk-breadcrumb">
		<li><a href="/">Home</a></li>
		<li><a href="{{ url_for('index.time') }}">Time</a></li>
		<li aria-current="page"><span>{{ time }}</span></li>
	</ul>

	<h1 class="">UK Box Office {{ time }}</h1>
</div>
{% endblock %}

{% block content %}

	<div class="uk-container uk-margin-medium-top">
		<div class="p-centered">

			<canvas id="myChart" class="mt-5" width="100%" height="50px"></canvas>
			<canvas id="barChart" class="mt-5" width="100%" height="50px"></canvas>

			<hr>
			<a class="uk-label" href="{{ url_for('index.year_detail', year=year) }}">{{ year }}</a>
			{% for j in range(1,13) %}
				<a class="uk-label" href="{{ url_for('index.month_detail', year=year, month=j) }}">{{ j|date_convert_to_month }}</a>
			{% endfor %}

			{% if next %}
			    <a class="uk-label" href="{{ url_for('index.time') }}{{next}}/">Next ></a>
			{% endif %}
		</div>

		<hr>

		<ul uk-accordion="multiple: true">
			<li>
				<a class="uk-accordion-title" href="#">Weeks</a>
				<div class="uk-accordion-content">
					<div class="uk-overflow-auto">
						<table class="uk-table uk-table-small uk-table-divider uk-table-hover uk-table-striped">
							<thead>
								<tr>
									<th>Date Week Ending</th>
									<th class="uk-text-center">Weekend Box Office</th>
									<th class="uk-text-center">Week Box Office</th>
									<th class="uk-text-center">Week Percent Change</th>
									<th class="uk-text-center">Number of Releases</th>
									<th class="uk-text-center">Number of Cinemas</th>
								</tr>
								</thead>
								<tbody>
									{% for i in graph_data|reverse %}
										<tr class="">
											<td><a class="action" href="{{ url_for('index.week_detail', year=i['date']['year'], month=i['date']['month'], start_day=i['date']['day']) }}">
												{{ i['date']|date_convert }}
											</a></td>
											<td class="uk-text-center">{{ "£ {:,}".format(i['weekend_gross']) }}</td>
											<td class="uk-text-center">{{ "£ {:,}".format(i['week_gross']) }}</td>
											{% if i['pct_change_week']|round(2) > 0 %}
												<td class="uk-text-success uk-text-center">{{ i['pct_change_week']|round(2) }}%</td>
											{% elif i['pct_change_week']|round(2) < 0 %}
												<td class="uk-text-danger uk-text-center">{{ i['pct_change_week']|round(2) }}%</td>
											{% else %}
												<td class="uk-text-center">-</td>
											{% endif %}
											<td class="uk-text-center">{{ i['id']}}</td>
											<td class="uk-text-center">{{ i['number_of_cinemas']}}</td>
										</tr>
									{% endfor %}
								</tbody>
						</table>
					</div>
				</div>
			</li>

			<li class="uk-open">
				<a class="uk-accordion-title" href="#">Films</a>
				<div class="uk-accordion-content">
					<button type="button" onclick="exportToCSV(filmsTable)" class="uk-button uk-button-default">
						Export (.csv)
					</button>

					<div class="uk-overflow-auto">
						<table class="uk-table uk-table-small uk-table-divider uk-table-hover uk-table-striped" id="filmsTable">
							<thead>
								<tr>
									<th class="uk-text-center">Rank</th>
									<th>Film</th>
									<th class="uk-text-center">Total Box Office</th>
								</tr>
							</thead>
							<tbody>
								{% for i in table_data %}
									<tr class="">
										<td class="uk-text-center">{{ loop.index }}</td>
										<td><a class="action" href="{{ url_for('index.film', slug=i['slug']) }}">{{ i['title']|title }}</a></td>
										<td class="uk-text-center">{{ "£ {:,}".format(i['week_gross']) }}</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</li>
		</ul>

	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js" integrity="sha512-Wt1bJGtlnMtGP0dqNFH1xlkLBNpEodaiQ8ZN5JLA5wpc1sUlk/O5uuOMNgvzddzkpvZ9GLyYNa8w2s7rqiTk5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<script>
		function graph(time_dates, week_gross) {
			var ctx = document.getElementById('myChart');
			var myChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: time_dates,
					datasets: [{
						label: 'Box Office',
						data: week_gross,
						backgroundColor: [
							'#FE7E6D',
						],
						borderColor: [
							'#FE7E6D',
						],
						pointStyle: 'circle',
						tension: 0.3,
						yAxisID: 'y'
					}]
				},
				options: {
					scales: {
						x: {
							grid: {
								display:false
							},
							offset: false,
						},
						y: {
							beginAtZero: true,
							ticks: {
								autoSkip: true,
								stepSize: 10000000,
								callback: function(value, index, values) {
									return '£ ' + value;
								}
							}
						},
					}
				}
			});
		}

		function bargraph(films, week_gross) {
			var ctx = document.getElementById('barChart');
			var myChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: films,
					datasets: [{
						label: 'Box Office',
						data: week_gross,
						backgroundColor: [
							'#FE7E6D',
						],
						borderColor: [
							'#FE7E6D',
						],
						yAxisID: 'y'
					}]
				},
				options: {
					scales: {
						x: {
							grid: {
								display:false
							},
							offset: true,
						},
						y: {
							beginAtZero: true,
							ticks: {
								autoSkip: true,
								stepSize: 10000000,
								callback: function(value, index, values) {
									return '£ ' + value;
								}
							}
						},
					}
				}
			});
		}

		function exportToCSV(tableEle, separator = ','){
		const head = ["Rank", "Film", "Box Office"]
		let csvRows = [head]
		//only get direct children of the table in question (thead, tbody)
		Array.from(tableEle.children).forEach(function(node){
			//using scope to only get direct tr of node
			node.querySelectorAll(':scope > tr').forEach(function(tr){
				let csvLine = []
				//again scope to only get direct children
				tr.querySelectorAll(':scope > td').forEach(function(td){
					//clone as to not remove anything from original
					let copytd = td.cloneNode(true)
					let data = copytd.textContent

					data = data.replace(/(\s\s)/gm, ' ').replace(/"/g, '""')
					csvLine.push('"'+data+'"')
				})
				csvRows.push(csvLine.join(separator))
			})
		})
		var a = document.createElement("a")
		a.style = "display: none; visibility: hidden" //safari needs visibility hidden
		a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvRows.join('\n'))
		a.download = '{{ time }}.csv'
		document.body.appendChild(a)
		a.click()
		a.remove()
	}

		var time_dates = []
		var week_gross = []
		'{% for i in graph_data %}'

			time_dates.push('{{ i["date"]|date_convert }}')
			week_gross.push('{{ i["week_gross"] }}')

		'{% endfor %}'

		graph(time_dates, week_gross)

		var films = []
		var box = []
		'{% for i in table_data[:20] %}'

			films.push('{{ i["title"][:20]|title }}')
			box.push('{{ i["week_gross"] }}')

		'{% endfor %}'

		bargraph(films, box)

	</script>

{% endblock %}
